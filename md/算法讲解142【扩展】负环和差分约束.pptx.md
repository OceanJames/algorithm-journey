<!-- Slide number: 1 -->
# 负环和差分约束
左程云
前置知识
讲解065 - spfa算法判断负环、Floyd算法
从讲解059到讲解065是图的基础内容章节，不熟悉的同学可以集中学习一下

本节课讲述

差分约束的两种形式
差分约束转化成利用spfa算法判断负环
若干变量确定的差分约束建图
差分约束和Floyd算法结合

注意：差分约束还可以和其他内容结合，比如强连通分量等内容，会在【挺难】阶段进一步讲述

<!-- Slide number: 2 -->
# 负环和差分约束
左程云
差分约束的两种形式
形式1，给定若干个不等式，类似Xi - Xj <= Ci，判断所有不等式是否有解，有解给出变量的一组解
其中Xi、Xj均为变量，Ci均为常量
形式2，给定若干个不等式，类似Xi - Xj >= Ci，判断所有不等式是否有解，有解给出变量的一组解
其中Xi、Xj均为变量，Ci均为常量

形式1和形式2可以相互转化，形式1判断负环(最短路)，形式2判断无限增加的环(最长路)

设置一个连通超级源点，然后利用spfa算法实现判断，时间复杂度O(n * m)，n为节点数，m为边数

得到一组变量的解(ans1, ans2 .. ansn)，那么就有无穷多解(ans1+d, ans2+d .. ansn+d)

课上重点图解

<!-- Slide number: 3 -->
# 负环和差分约束
左程云
题目1
负环和差分约束模版题
一共有n个变量，编号1~n，给定m个不等式，每个不等式的形式为
Xi - Xj <= Ci，其中Xi和Xj为变量，Ci为常量
如果不等式存在矛盾导致无解，打印"NO"
如果有解，打印满足所有不等式的其中一组解(X1, X2...)
1 <= n、m <= 5 * 10^3
-10^4 <= Ci <= +10^4
测试链接 : https://www.luogu.com.cn/problem/P5960

形式1 + 判断负环

形式2 + 判断无限增加的环

<!-- Slide number: 4 -->
# 负环和差分约束
左程云
题目2
小k的农场
一共有n个农场，编号1~n，给定m条关系，每条关系是如下三种形式中的一种
关系1 a b c : 表示农场a比农场b至少多种植了c个作物
关系2 a b c : 表示农场a比农场b至多多种植了c个作物
关系3 a b   : 表示农场a和农场b种植了一样多的作物
如果关系之间能推出矛盾，打印"No"，不存在矛盾，打印"Yes"
1 <= n、m <= 5 * 10^3
1 <= c <= 5 * 10^3
测试链接 : https://www.luogu.com.cn/problem/P1993

基础模版题

<!-- Slide number: 5 -->
# 负环和差分约束
左程云
题目3
布局奶牛
编号1到编号n的奶牛从左往右站成一排，你可以决定任意相邻奶牛之间的距离
有m1条好友信息，有m2条情敌信息，好友间希望距离更近，情敌间希望距离更远
每条好友信息为 : u v w，表示希望u和v之间的距离 <= w，输入保证u < v
每条情敌信息为 : u v w，表示希望u和v之间的距离 >= w，输入保证u < v
你需要安排奶牛的布局，满足所有的好友信息和情敌信息
如果不存在合法方案，返回-1
如果存在合法方案，返回1号奶牛和n号奶牛之间的最大距离
如果存在合法方案，并且1号奶牛和n号奶牛之间的距离可以无穷远，返回-2
测试链接 : https://www.luogu.com.cn/problem/P4878

题目的模型转化成差分约束建图

<!-- Slide number: 6 -->
# 负环和差分约束
左程云
若干变量确定的差分约束建图

如果有些变量直接确定了值，如何判断给定的不等式关系是否有解？

超级源点的设计
1, 连通超级源点，比如0号点，向所有节点连接权值为0的有向边，保证图的连通性
2, 限制超级源点，比如n+1号点，然后对直接确定了值的节点连接一组正、负的边
3, 利用spfa判断负环，如果出现了负环说明有矛盾
4, 特别注意，连通超级源点 和 限制超级源点，一定要分离

课上重点图解

<!-- Slide number: 7 -->
# 负环和差分约束
左程云
题目4
倍杀测量者
如果 A的分数 >= B的分数 * k，k是正实数，就称 A k倍杀 B，或称 B被A k倍杀了
一场比赛中，一共有n个选手，有m1条誓言记录，有m2条选手得分记录，得分只可能是正实数
类型1的誓言 u v k : 选手u 没有k倍杀 选手v，那么选手u就穿女装
类型2的誓言 u v k : 选手u 被选手v k倍杀了，那么选手u就穿女装
选手的得分    u w : 选手u得了w分，如果某选手没有得分记录，按照尽量不穿女装的情况推测
你希望看到比赛后有人穿女装，但不想看到很多人穿女装，于是想制定正实数ans，效果如下
类型1的誓言，比例调整成(k-ans)，类型2的誓言，比例调整成(k+ans)，即提高了穿女装的条件
计算ans最大多少，依然有人穿女装，保留小数点后4位，如果不干预也没人穿女装，返回-1
测试链接 : https://www.luogu.com.cn/problem/P4926

二分答案  +  Xi / Xj >= Ci转化为普通差分约束的形式  +  若干变量确定的差分约束建图

<!-- Slide number: 8 -->
# 负环和差分约束
左程云
题目5
天平
一共有n个砝码，编号1~n，每个砝码的重量均为1克，或者2克，或者3克
砝码与砝码之间的关系是一个n * n的二维数组s
s[i][j] == '+'，砝码i比砝码j重         s[i][j] == '-'，砝码i比砝码j轻
s[i][j] == '='，砝码i和砝码j重量一样    s[i][j] == '?'，砝码i和砝码j关系未知
数据保证至少存在一种情况符合该矩阵
给定编号为a和b的砝码，这两个砝码一定会放在天平的左边，你要另选两个砝码放在天平右边
返回有多少种方法，一定让天平左边重(ans1)，一定让天平一样重(ans2)，一定让天平右边重(ans3)
1 <= n <= 50
测试链接 : https://www.luogu.com.cn/problem/P2474

差分约束 + Floyd算法