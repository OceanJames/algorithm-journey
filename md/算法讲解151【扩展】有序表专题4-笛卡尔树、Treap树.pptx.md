<!-- Slide number: 1 -->
# 笛卡尔树、Treap树
左程云
前置知识
讲解044-前缀树  整个专题的要求

有序表专题安排
专题1：AVL树，讲解148
专题2：跳表，讲解149
专题3：替罪羊树，讲解150
专题4：笛卡尔树、Treap树，讲解151，本节
专题5：FHQ Treap树，讲解152
专题6：Splay树，讲解153

大厂笔试、算法竞赛掌握以上有序表结构足够，其他有序表结构不再讲述，面试遇到只是聊，可以自行学习
算法竞赛的同学，有序表必带模版：替罪羊树、Treep树、FHQ Treap树、Splay树
Splay树是实现Link-Cut-Tree的关键，这个结构的讲述，会在【挺难】阶段的课程里安排

<!-- Slide number: 2 -->
# 笛卡尔树、Treap树
左程云
本节课讲述
笛卡尔树，题目1
Treap树，题目2
笛卡尔树相关题目，题目3、题目4、题目5、题目6
注意，本节课讲述Treap树 + 旋转法，下节课讲述Treap + FHQ，这才是Treap的重点

笛卡尔树、Treap树需要的前置知识
讲解025 - 堆结构
讲解052 - 单调栈
讲解148 - AVL树，理解什么是搜索二叉树、左旋、右旋

笛卡尔树相关题目需要的前置知识
讲解078、讲解079 - 树型dp，本节课题目4、题目5需要
讲解099 - 逆元和除法同余，其中阶乘余数表、阶乘逆元表、连续数字逆元表，本节课题目5、题目6需要

<!-- Slide number: 3 -->
# 笛卡尔树、Treap树
左程云
笛卡尔树
一般默认key没有相同值，key按照搜索二叉树组织，value按照小根堆或者大根堆组织
不是狭义的小根堆或者大根堆
整棵子树的最小值或最大值，一定是子树的头，但不要求子树一定为完全二叉树，这种广义的堆

笛卡尔树建树过程，时间复杂度O(n)
1，当前插入节点假设为x，依据x的value值，在单调栈中依次弹出节点
2，最晚弹出的节点y及其整棵子树，成为x的左树
3，假设x在单调栈中压着z节点，那么x就成为z的右孩子
4，节点x根据value值加入单调栈

课上重点图解笛卡尔树的建树过程

本节课题目3、题目4、题目5、题目6，都是笛卡尔树相关题目

<!-- Slide number: 4 -->
# 笛卡尔树、Treap树
左程云
题目1
笛卡尔树模版
给定一个长度为n的数组arr，下标从1开始
构建一棵二叉树，下标按照搜索二叉树组织，值按照小根堆组织
建树的过程要求时间复杂度O(n)
建树之后，为了验证
打印，i * (left[i] + 1)，所有信息异或起来的值
打印，i * (right[i] + 1)，所有信息异或起来的值
1 <= n <= 10^7
测试链接 : https://www.luogu.com.cn/problem/P5854

<!-- Slide number: 5 -->
# 笛卡尔树、Treap树
左程云
Treap树
Treap树就是笛卡尔树，key按搜索二叉树组织，priority代表节点的优先级，是随机的，按堆组织

插入(key, priority)这个节点时，先根据key在搜索二叉树上移动，确定插入的位置
然后根据priority的大小，决定节点是否向上移动，向上移动通过左旋、右旋来实现

删除(key, priority)这个节点时，先在搜索二叉树上，找到key的节点所在的位置
1，无左无右，直接删掉。2，有左无右，左孩子接替其位置。3，无左有右，右孩子接替其位置
4，如果节点有左有右，那么优先级最大的孩子接替其位置，可以利用左旋、右旋实现
此时节点被旋转到了或往左、或往右的子树里，继续在子树上删掉该节点

随机优先级的方式，保证了Treap树的平衡性，增删改查时间复杂度O(log n)，非常类似跳表

课上重点图解Treap树增加、删除、查询的过程，下节课是FHQ-Treap，这才是Treap的重点内容

<!-- Slide number: 6 -->
# 笛卡尔树、Treap树
左程云
题目2
Treap树的实现
实现一种结构，支持如下操作，要求单次调用的时间复杂度O(log n)
1，增加x，重复加入算多个词频
2，删除x，如果有多个，只删掉一个
3，查询x的排名，x的排名为，比x小的数的个数+1
4，查询数据中排名为x的数
5，查询x的前驱，x的前驱为，小于x的数中最大的数，不存在返回整数最小值
6，查询x的后继，x的后继为，大于x的数中最小的数，不存在返回整数最大值
所有操作的次数 <= 10^5
-10^7 <= x <= +10^7
测试链接 : https://www.luogu.com.cn/problem/P3369

<!-- Slide number: 7 -->
# 笛卡尔树、Treap树
左程云
题目3
树的序
给定一个长度为n的数组arr，表示依次插入数字，会形成一棵搜索二叉树
也许同样的一个序列，依次插入数字后，也能形成同样形态的搜索二叉树
请返回字典序尽量小的结果
1 <= n <= 10^5
测试链接 : https://www.luogu.com.cn/problem/P1377

<!-- Slide number: 8 -->
# 笛卡尔树、Treap树
左程云
题目4
序列计数
有一个概念叫，最左端最大值位置，表示一段范围上
如果最大值有一个，那么最大值所在的位置，就是最左端最大值位置
如果最大值有多个，最左的那个所在的位置，就是最左端最大值位置
给定一个长度为n的数组A，那么必然存在等长的数组B，当选择同样的子范围时
两者在这段范围上，最左端最大值位置是相同的，不仅存在这样的数组B，而且数量无限多
现在要求，数组B中的每个值都在[1,m]范围，返回有多少个这样的数组，答案对 1000000007 取模
2 <= n、m <= 2 * 10^5    1 <= A[i] <= m    n * m <= 10^6
测试链接 : https://www.luogu.com.cn/problem/CF1748E
测试链接 : https://codeforces.com/problemset/problem/1748/E

1，数组A上求的笛卡尔树，得到的下标组织就是最左端最大值的划分，填入值时，左<=头-1，右<=头
2，转化为树型dp，先得到头节点严格等于j的方法数，再去生成头节点<=j的方法数

<!-- Slide number: 9 -->
# 笛卡尔树、Treap树
左程云
题目5
表格填数
给定一个长度为n的数组arr，arr[i]表示i位置上方的正方形格子数量
那么从1位置到n位置，每个位置就是一个直方图，所有的直方图紧靠在一起
在这片区域中，你要放入k个相同数字，不能有任意两个数字在同一行或者同一列
注意在这片区域中，如果某一行中间断开了，使得两个数字无法在这一行连通，则不算违规
返回填入数字的方法数，答案对 1000000007 取模
1 <= n、k <= 500    0 <= arr[i] <= 10^6
测试链接 : https://www.luogu.com.cn/problem/P6453

1，k * k的区域，填k个数字行列不冲突方法数问题，k!
2，n * m的区域，填k个数字行列不冲突方法数问题，c(n,k) * c(m,k) * k!
3，多边形区域利用笛卡尔树做划分的处理，转化成矩形区域填数的问题
4，树上dp的转移，子树填入数字的个数会占用列的名额，剩余数字在父区域上填入的方法数转化为2的结论

<!-- Slide number: 10 -->
# 笛卡尔树、Treap树
左程云
题目6
砖块消除
给定一个长度为n的数组arr，arr[i]为i号砖块的重量
选择一个没有消除的砖块进行消除，收益为被消除砖块联通区域的重量之和，比如arr = {3,5,2,1}
如果先消除5，那么获得3+5+2+1的收益，arr = {3,X,2,1}
如果再消除1，那么获得2+1的收益，arr = {3,X,2,X}
如果再消除2，那么获得2的收益，arr = {3,X,X,X}
如果再消除3，那么获得3的收益，arr = {X,X,X,X}
一共有n!种消除方案，返回所有消除方案的收益总和，答案对 1000000007 取模
1 <= n <= 10^5    1 <= arr[i] <= 10^9
测试链接 : https://www.luogu.com.cn/problem/AT_agc028_b
测试链接 : https://atcoder.jp/contests/agc028/tasks/agc028_b

消除方案的收益总和 -> i位置有多少祖先节点的期望 -> 利用笛卡尔树分析，x位置是i位置的祖先的概率